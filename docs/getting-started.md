# RoLIMOA 運用ガイド

このドキュメントでは、実際の大会でRoLIMOAを使う流れや準備方法、設定の記述方法を説明します。

## 最初の準備

まずはデフォルトの状態でRoLIMOAが動作することを確認してください。次のようにリポジトリをクローンして、ビルドします。

```bash
# リポジトリをクローン
git clone https://github.com/kishimotonico/RoLIMOA.git
cd RoLIMOA

# 依存関係をインストール
npm install

# 本番用にビルド
npm run build

# サーバーを起動
npm start
```

サーバーが起動すると `http://localhost:8000` でアクセスできるようになります。詳細はREADME.mdも参照してください。

## 競技ルールの設定

実際の大会でRoLIMOAを利用するためには、ルールに合わせた設定に変更する必要があります。
競技ルールなどを `packages/common/src/config/config.ts` で設定します。

### 1. 大会情報

```typescript
contest_info: {
  name: 'サンプルロボコン2025',  // 大会名
}
```

### 2. ルール - タスクオブジェクトの定義

RoLIMOAでは "タスクオブジェクト" というKey-Value形式のオブジェクトを管理することで、得点を管理しています。
得点を計算するための変数と考えてください。得点入力画面では、このタスクオブジェクトの数値を増減するUIを提供します。

```typescript
task_objects: [
  {
    id: 'Utsunomiya',        // 内部ID
    description: '宇都宮',    // 画面表示名
    initialValue: 0,         // 初期値
    min: 0,                  // 最小値（省略可）
    max: 1,                  // 最大値（省略可）
  },
  // ... 他の得点要素
]
```

### 3. 得点計算ルール

タスクオブジェクトから得点を計算するルールを定義します。

最も簡単な `format: 'simple'` で得点計算を定義するのがおすすめです。タスクオブジェクト(`id`)と、それに対応する得点(`coefficient`)を設定します。

```typescript
score: {
  format: 'simple',
  expression: [
    {
      id: 'Utsunomiya',       // タスクオブジェクトのID
      coefficient: 10,        // 点数（宇都宮×10点）
    },
    // ... 他の要素
  ],
}
```

### 4. Vゴール条件

Vゴールの名称を変更します。`type: 'alwaysOk'` で常にVゴール可能な設定にしておくのがおすすめです。

```typescript
vgoal: {
  name: 'Vゴール',           // Vゴール名
  condition: {
    type: 'alwaysOk',        // 常に可能
  },
}
```

Vゴールが不要な場合、 `type: 'disabled'` で常にVゴール不可能な設定にできます。

```typescript
vgoal: {
  name: 'Vゴール',           // Vゴール名
  condition: {
    type: 'disabled',        // 無効化
  },
}
```

### 5. 操作パネルの設定

得点入力画面のUIは、設定が不要な `type: 'default'` を使うのが簡単でおすすめです。
各タスクオブジェクトに対して「-1 / +1」のボタンが表示できます。

```typescript
control_panel: {
  type: 'default',
}
```

ボタンの詳細な配置や機能を指定したい場合や、チェックボックスなどのUIを使いたい場合、`type: 'custom'` を指定して詳細を設定できます。

```typescript
control_panel: {
  type: 'custom',
  panels: [
    {
      id: 'Utsunomiya',      // タスクオブジェクトのIDと対応
      type: 'multi_button',
      option: {
        buttons: [
          {
            command: '=0',    // 0にセットする
            label: '0',       // ボタン表示名
            style: {
              variant: 'outlined',  // ボタンスタイル
            },
          },
          {
            command: '+1',    // +1点
            label: '+1',
            shortcutKey: 'Q', // キーボードショートカット
          },
        ],
      },
    },
    // ... 他のパネル
  ],
}
```

### 6. タイマー設定

RoLIMOAではセッティングタイムやカウントダウン、競技中などの状況を "フェーズ" として定義しています。
`id: 'match'` のフェーズの `duration: 180` が競技時間の秒数設定です。


```typescript
time_progress: [
  //
  // ... 中略 ...
  //
  {
    id: 'match',
    type: 'count',
    duration: 180,
    description: '競技中',
    style: {
      timerFormat: 'm:ss',
      timerType: 'countup',
    },
    custom: [
      {
        elapsedTime: 0,
        displayText: 'GO',
        sound: 'tone_880hz_1000ms.mp3',
      },
      // ... 効果音再生など他の設定
    ],
  },
  {
    id: 'match_finish',
    type: 'ready',
    description: '試合終了',
    custom: [
      {
        elapsedTime: 0,
        displayText: '--   --',
      },
    ],
  },
],
```

### 7. チーム名の事前設定

大会前にチーム情報を登録しておくと、試合開始時に自動で反映されます。

```typescript
teams_info: [
  {
    id: '1',
    name: 'チーム名',
    school: '学校名',
    short: 'チーム名（学校名）',  // 短縮表示用
  },
  // ... 他のチーム
]
```


## 大会当日の運用フロー

### 運用に利用するデバイス

1台のPCだけでも運用できますが、RoLIMOAでは次のように複数のデバイスから操作するのを想定しています。

- **メインPC** (試合管理用PC): サーバーを起動するPCが必要です。サーバーと同じPCで試合管理（マスタ）画面を開くのを推奨します
- **得点入力用デバイス**: 青・赤コートの担当者が得点を操作するためのPCやスマホが必要です
- **スクリーン用PC**: 会場のプロジェクタにスクリーン画面を表示するPC。タイマーの時間ずれ防止のため、メインPCと兼用がおすすめです
- **配信用PC**: ライブ配信に使うPC。OBSのBrowser Sourceで配信オーバーレイ画面を表示します

また、これらのデバイスからRoLIMOAの画面を使うために、Wi-FiルーターなどでLAN環境を用意してください。

### 試合当日の操作手順

#### ステップ1: 準備

1. メインPCでサーバーを起動します
    ```bash
    npm start
    ```
2. メインPCで `http://localhost:8000` にアクセス
3. 他のデバイスでも同じLANに接続し、各デバイスで `http://[メインPCのIPアドレス]:8000` にアクセスします

#### ステップ2: 各デバイスで、各画面を開く

- **試合管理（マスタ）画面**: メインPCでの試合進行管理用
- **スクリーン画面**: 会場のメインスクリーン用（効果音も再生される）
- **青/赤チーム入力画面**: 各コートの担当者用
- **主審入力画面**: 試合全体の確認・結果確定用
- **配信オーバーレイ画面**: OBSのBrowser Source用（1600x900推奨）

**⚠️ 重要**: 試合管理画面は**1つのタブのみ**で開いてください。仕様上、複数のタブやデバイスで開くとフェーズ遷移が正常に機能しません。

#### ステップ3: 試合管理画面での試合進行操作

1. 青・赤のチーム名を選択、もしくは入力して〔試合開始〕ボタンを押す
1. 〔次のフェーズへ〕でセッティングタイム（デフォルトでは1分）を開始
1. 再度〔次のフェーズへ〕を押すと、カウントダウンが始まり、競技中フェーズに移行する
1. 各担当者が得点入力画面で得点を入力
1. 試合終了後、主審画面で〔試合結果を確定〕


## 各ページの一覧

### 試合管理（マスタ）画面

#### 🎯 役割
試合全体の進行を制御する管理画面

#### ⚠️ 重要
この画面は**必ず1つのタブのみ**で開いてください。複数のデバイスで開くと、仕様上、正常にフェーズ遷移しないことがあります。

#### 時刻マスタ

タイマーを管理するパネルです。大会では基本的に〔次のフェーズへ〕ボタンを押すことで、セッティングタイムや競技前のカウントダウンをスタートします。
フェーズを操作するボタングループがあり、これで試合の状態やフェーズを操作できます。

- 最初のフェーズ (試合開始準備中)に遷移する
- 1つ前のフェーズに遷移する
- タイマーを停止する
- 1つ後のフェーズに遷移する
- 最後のフェーズ (試合終了)に遷移する

また、タイマーが停止されている状態では、タイムカウントの変更も可能です。タイマーの下にある時刻操作ボタングループでは、次の操作が可能です。

- **-10**: 競技時刻を10秒戻す
- **-1**: 競技時刻を1秒戻す
- **+1**: 競技時刻を1秒進める
- **+10**: 競技時刻を10秒進める

> [!NOTE]
> 📝**仕様**: RoLIMOAでは、現在のタイマーを `(システムの現在時刻) - (タイマー開始時の時刻)` で計算しています。そのため、デバイスの時刻が正確になるように設定してください

#### 試合マスタ

試合を開始するパネルです。試合名・青チーム名・赤チーム名を入力して〔試合開始〕を押すことで、次の試合を始めることができます。

試合開始ボタンを押すと、現在の得点などが全てリセットされます。現在の試合が進行中の場合はボタンが押せないため、フェーズ操作ボタンで「試合終了」の状態にしてください。

試合名、チーム名はいずれも空欄のまま試合開始できます。チーム名は事前に packages/common/src/config/config.ts で設定したチーム名をドロップダウンで選択できますが、テキストボックスに任意文字を入力可能です。

#### デバイス管理

RoLIMOAに接続しているデバイスの一覧を表示するパネルです。各デバイスの開いているページを確認できます。主に、管理画面を開いているデバイスが1つだけであることや、不要なデバイスが接続されていないことを確かめるために使います。

パネル左下にある保存アイコンボタンは、サーバーで試合の状態や結果を保存するボタンです。保存機能が仮の実装のため分かりづらいUIになっていますが、正式に実装したときに画面仕様が変わる予定です。

サーバが終了したとき、試合結果は消えます。ただ、試合履歴の保存機能を試験的に実装しました。試合管理画面のデバイス管理にある保存ボタンを押すと、packages/server/save/store_YYYYMMDDHHMMSS.jsonに保存します。このファイルがある場合は、再起動時に最も新しいものが読み込まれます。

### 青・赤チーム入力

#### 🎯 役割
青チーム、赤チームそれぞれの得点を入力する画面

#### 得点操作パネル

画面左側は、得点を入力するためのUIがあるパネルです。基本的にはタスクオブジェクト、グローバルオブジェクトのそれぞれについて増減（+1 / -1）するボタンが表示されます。 config.ts の `rule.control_panel` の設定によって、ボタンの配置や機能が変わります。

RoLIMOAでは、青コートの担当者、赤コートの担当者がそれぞれ自分のPCやスマホで得点を入力する運用を想定しています。そのため、両チームの得点を同時に入力できる画面はありません。

#### スコア有効スイッチ

得点の有効・無効を切り替えるスイッチボタンです。

以前の大会で得点がNULLの場合があったため機能として残っていますが、基本的に使うことはありません。

#### 勝利フラグスイッチ

チームが勝利したことを設定するスイッチボタンです。勝利フラグが設定されたチームは、配信画面で"Winner"が表示されたり、試合記録で勝者として記録されます。

注意点として、青・赤チームのそれぞれで独立して勝利フラグを管理しています。そのため、両方のチームに勝利フラグが立つことも可能です。

#### Vゴールボタン

チームがVゴールしたときに押すボタンです。config.tsの `rule.vgoal.condition` で設定した条件を満たしたときのみボタンが押せます。

Vゴールボタンを押すと、ボタンを押した時点での時刻をもとにVゴールタイムを記録します。Vゴールタイムは得点入力したデバイスの時刻を元に計算されます。テキストボックスでVゴールタイムを変更することが可能です。

### 主審入力画面

#### 🎯 役割

試合の結果を確認して、結果を確定する画面です。

#### 📝 補足

試合結果の確定が不要な場合など、運用によっては使わなくてもよい画面です。得点入力画面では、相手コートの得点を確認できないため、結果を一覧するために作成しました。

#### 現在の試合パネル

現在進行中の試合について、青・赤チームの得点状況を一覧するテーブルです。

試合終了フェーズになると〔試合結果を確定〕ボタンを押すことができます。試合結果を確定すると、ダッシュボードに試合の結果が追加されます。

#### 操作履歴パネル (β版)

青・赤チームの得点入力や、タイマーの操作などの履歴を一覧するテーブルです。

### 配信オーバーレイ画面

#### 🎯 役割

YouTubeなどへの配信に表示するための配信オーバーレイ画面を管理するための画面です。

#### 配信オーバーレイURL

テキストボックスにあるURLをコピーして、OBSの内部ブラウザで表示して使います。

URLには、青・赤チームの左右反転フラグ (`reverse`)やタイマーの時刻調整 (`timeOffset=0`) のクエリパラメータが付きます。

#### HUD表示スイッチボタン

〔メインHUDを表示する〕をオフにすると、配信オーバーレイ画面の得点やタイマー表示が全て非表示になります。

〔スコアを表示する〕をオフにすると、青・赤チームの得点のみが非表示になります。メインHUDが表示されていれば、タイマーは表示されたままです。

このボタンは各デバイス間で状態が共有されるため、配信PC以外からの操作も可能です。

```
メインHUD
 ├ スコア表示
 │   ├ 青チーム得点
 │   └ 赤チーム得点
 └ タイマー表示
```

### スクリーン画面

#### 🎯 役割

会場でのスクリーンなどにタイマーや得点を表示する画面です。

#### 💡 Tips

プロジェクターでこのスクリーン画面を会場に映す運用を想定しています。タイマーの時刻ずれを防ぐため、メインPCで開くのがおすすめです。

効果音が鳴るのもこのページです。ブラウザの自動再生ポリシーの問題で効果音が再生されない場合があるため、ページ表示後に一度クリックするようにしてください。

#### 左右反転ボタン

スクリーン画面にはボタンがほとんどありませんが、赤・青チームの得点表示の間に左右反転ボタンがあります。マウスオーバーしないと見えづらいようになっています。


## よくある問題と対処法

### 効果音が再生されない

**症状**: スクリーン画面で効果音やカウントダウン音が再生されない

**原因**: ブラウザの自動再生ポリシーによる制限

**対処法**:
1. **画面をクリック**:
  - ユーザーがクリックなどの操作をしないと、音声が自動再生されないケースがある
  - スクリーン画面上の適当な箇所をクリックする
2. **ブラウザを変更**: 
  - Chromeを使っている場合、Firefoxなどの別ブラウザを試す
3. **ブラウザ設定を確認**: 
  - サイト設定で音声の自動再生を「許可」に変更
  - アドレスバー左の🔒アイコン → サイトの設定 → 音声
4. **コンソールでエラー確認**: 
  - F12でデベロッパーツールを開き、Consoleタブでエラーなどを確認

### デバイスごとにタイマーがずれている

**症状**: タイマーの時間がデバイス間で数秒ずれている

**原因**: 各デバイスの日時設定がずれている

**対処法**:
1. **デバイスの日時を同期**:
  - PCやスマホをなるべく正確な日時に更新する
  - もしくは、メインPCにNTPサーバーを設定して他のデバイスと時刻を合わせる
2. **時刻オフセットを設定**:
  - 各デバイスで、画面右上の歯車アイコンから設定画面を開く
  - メインPCを基準に、他のデバイスで時刻のずれがなくなるようにオフセットを調整する

### 他のデバイスからアクセスできない

**症状**: メインPC以外のデバイスで `http://[IPアドレス]:8000` にアクセスできない

**原因**: サーバーのバインディング設定、ファイアウォール、またはネットワーク設定の問題

**対処法**:
1. **IPアドレスを確認**: 
  - Windows: `ipconfig` コマンド
  - Mac/Linux: `ifconfig` または `ip addr` コマンド
2. **ファイアウォール設定**:
  - Windowsファイアウォールでポート8000番を許可
  - セキュリティソフトの設定を確認
3. **同じネットワークにいるか確認**:
  - 同じWiFiに接続しているか
  - `ping [IPアドレス]` で疎通確認

## その他、既存バグや運用上の注意

### 音声再生の問題
- スクリーン画面で効果音を再生する際、ブラウザの自動再生ポリシーの影響を受ける
- Chrome以外のブラウザで動作が改善する場合がある

### タイマーの二重生成バグ (解決済)
- 過去事例として、本来の試合終了よりも早く効果音が鳴るバグが発生したことに要注意
- 内部タイマーが二重起動してしまったことが原因で、発生時はタイマーのちらつきが発生する
- 再現した場合は、スクリーン画面を再読み込みして対応

### 試合管理の制約
- 試合管理（マスタ）画面は1つのタブのみで開く必要がある
- サーバー終了時に試合結果が消失（保存機能は試験的実装）
