# RoLIMOA: **Ro**bocon **L**ivestreaming **I**ntegrated **M**atch **O**perating **A**pp

NHK学生ロボコンのようなロボットコンテストの大会で、青・赤チームの得点を各担当が入力し、それを会場のスクリーンやライブストリーミング（動画配信）に表示する統合的なシステムです。

[![demo](./docs/demo-video.gif)](https://www.youtube.com/watch?v=NV2unpMqg-M)

## 機能 / features

![RoLIMOAの想定構成図](./docs/RoLIMOAの想定構成図.drawio.png)

- NHK学生ロボコン・高専ロボコンと同じ、青コートと赤コートによる2チームの対戦形式
- 毎年変わるルールに合わせ、JSONで得点計算やVゴール名などを柔軟に設定
- スクリーンや配信画面に、対戦チーム名や得点、タイマーを表示
- 各デバイスでの操作した得点は、他のデバイスとリアルタイムに同期


## 使い方 / Usage

> [!NOTE]
> 📖 **運用ガイド**: 実際の大会での使用方法、設定ファイルの編集、トラブルシューティングについて、詳しくは [docs/getting-started.md](./docs/getting-started.md) を参照してください

### 設定ファイルの編集

競技ルールの設定は `packages/common/src/config/config.ts` で行います。特にルールに関する `rule.task_objects`, `rule.score`, `rule.vgoal` を編集します。

### 本番環境の起動

サーバ側でクライアントのビルド済みファイルをホスティングしているので、実際の大会時には次のような運用を想定しています。

```bash
# 事前にビルド
git clone https://github.com/kishimotonico/RoLIMOA.git
cd RoLIMOA
npm install
npm run build

# サーバーを起動
npm start
```

http://localhost:8000 で管理画面を開けるようになります。OSやファイアウォールを設定すれば、他のデバイスからも操作できます。

### 詳しい操作方法

#### 「試合管理（マスタ）」画面

「試合管理（マスタ）」画面を開き、試合名・青チーム名・赤チーム名を入力して〔試合開始〕を押します。〔次のフェーズへ〕のボタンでセッティングタイムや競技を始めることができます。以後、この画面のタブは常に開いたままにします。また、試合管理画面は1つのタブのみで開く必要がある点に注意してください。

#### スクリーン画面

カウントダウンや競技終了の効果音は「スクリーン」画面で再生されます。カウントダウンやフェーズ遷移時のラグを防止するため、試合管理画面とスクリーン画面は、サーバを起動したのと同じPCで表示することを推奨します。

注意点として、スクリーン画面の音声再生は環境に依存するので、効果音が遅れる場合があります。Chromeでは音声の自動再生を許可してください。Firefoxなど別ブラウザを使うと挙動が改善するケースもあります。

#### 得点入力、主審入力画面

別のタブやデバイスで「青/赤チーム入力」画面を開き、得点を入力します。実際の大会では、各コートの担当者複数名が同時に入力する想定です。

「主審入力」画面では、両チームの得点状況を一覧できます。Googleスプレッドシートなど別記録へ転記しやすくするために実装しました。また、試合終了フェーズでは〔試合結果を確定〕することができます。結果を確定すると、ダッシュボードに試合の結果が記録されます。

#### 配信オーバーレイ画面

「配信オーバーレイ」画面は、YouTubeなどへの配信画面に表示するために使います。OBSのBrowser Sourceで、1600x900の大きさで表示する想定です。会場の音声を取り込むため、配信オーバーレイでは音声を再生していません。

#### データ保存について

サーバが終了したとき、試合結果は消えます。ただ、試合履歴の保存機能を試験的に実装しました。試合管理画面のデバイス管理にある保存ボタンを押すと、packages/server/save/store_YYYYMMDDHHMMSS.jsonに保存します。このファイルがある場合は、再起動時に最も新しいものが読み込まれます。


## 開発方法 / How to develop

```bash
npm run dev
```

サーバーとクライアントを同時に起動します。

### アーキテクチャ

#### モノレポ構成
- `packages/common/`: 共通型定義、Redux設定、設定ファイルスキーマ
- `packages/client/`: React フロントエンド (Vite)
- `packages/server/`: Express サーバー (WebSocket通信)

#### 状態管理
- Redux Toolkit（共通）+ Recoil（クライアント固有）
- サーバー・クライアント間でReduxスライスを一部共有
- WebSocketでリアルタイム同期

#### 設定システム
- `packages/common/src/config/config.ts` で競技ルール設定
- Zodスキーマ（`packages/common/src/config/schema/`）で型検証
- 多様なルールに対応するための得点の管理
    - "タスクオブジェクト" という仮想的なオブジェクトを定義
    - 得点入力画面では、各タスクオブジェクトの増減を操作
    - 得点は、タスクオブジェクト (Key-Value形式) から算出

### 技術スタック
- TypeScript
- React + MUI
- Redux Toolkit
- Recoil
- WebSocket
- Express + express-ws
- Vite (build)
- Biome (lint/format)

### リント・フォーマット

```bash
npm run lint     # 全ワークスペースでBiome lintを実行
npm run format   # 全ワークスペースでBiome formatを実行
```

### 🐋 Docker対応

本番環境:
```bash
docker build -t rolimoa .
docker run -p 8000:8000 rolimoa
```

開発環境:
```bash
docker compose up -d
```


## その他、既存バグや運用上の注意

### 音声再生の問題
- スクリーン画面で効果音を再生する際、ブラウザの自動再生ポリシーの影響を受ける
- Chrome以外のブラウザで動作が改善する場合がある

### タイマーの二重生成バグ (解決済)
- 過去事例として、本来の試合終了よりも早く効果音が鳴るバグが発生したことに要注意
- 内部タイマーが二重起動してしまったことが原因で、発生時はタイマーのちらつきが発生する
- 再現した場合は、スクリーン画面を再読み込みして対応

### 試合管理の制約
- 試合管理（マスタ）画面は1つのタブのみで開く必要がある
- サーバー終了時に試合結果が消失（保存機能は試験的実装）

### TODO: 今後追加したい機能
- 各試合のログ保存・再生機能
